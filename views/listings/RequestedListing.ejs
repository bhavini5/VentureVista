<!-- 
<style>
  /* Style for review cards */
/* Style for review cards */
/* Style for review cards */
.card {
    border: 1px solid #ddd;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    display: flex; /* Use flexbox to align items */
    align-items: flex-start; /* Align items at the start of the flex container */
    gap: 1rem; /* Spacing between elements */
}

.card-title {
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

.card-text {
    font-size: 1rem;
    margin-bottom: 0.5rem;
    overflow-wrap: break-word;
}

.starability-result {
    font-size: 1.2rem;
    color: #ffc107;
    margin-bottom: 0.5rem;
}

/* Style for image container */
.imgReview {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem; /* Spacing between images */
}

.imgReview img {
    height: 100px;
    width: 100px;
    object-fit: cover;
    border-radius: 0.3rem;
}

/* Style for review content */
.review-content {
    flex: 1; /* Allow content to expand and fill available space */
}

</style> -->
<style>
/* Styles for the request box container */
.requestBox {
    border: 1px solid #ccc;
    padding: 10px;
    margin-top: 20px;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Styles for the "All Requests" header */
.requests {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}

/* Styles for each request item */
.requestItem {
    display: flex; /* Use flexbox for inline layout */
    align-items: center; /* Center align items vertically */
    margin-bottom: 10px;
}

/* Styles for email text */
.email {
    flex: 1; /* Allow email text to grow and fill remaining space */
    margin-right: 10px; /* Add spacing between email and button */
}

/* Styles for the accept button */
.acceptButton {
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
}

</style>
<% layout ("/layouts/boilerplate") %>
<script>
const mapToken =  "<%= process.env.Map_Token %>";
const listing =  <%-JSON.stringify(listing) %>;
</script>
<div class="row mt-3">
    <div class="col-8 offset-2">
        
    </div>
         
          <div class="card col-6 offset-3 show-card listing-card" >
            <div class="row-with-req">
              <h3><%=listing.title%></h3>
              <div class="row">
                <div class="col">
                  <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                      <% let isFirst = true; %>
                      <% for (let image of listing.image) { %>
                        <div class="carousel-item <%= isFirst ? 'active' : '' %>">
                          <img  style="height: 25rem; width: 8rem; border-radius: 2rem;" src="/uploads/<%= image %>" class="d-block w-100" alt="listing_image">
                        </div>
                        <% isFirst = false; %>
                      <% } %>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="visually-hidden">Next</span>
                    </button>
                  </div>
                </div>
              </div>
              <!-- Output listing status for debugging -->
              
              <!-- Conditional rendering based on status -->
               

              <div class="requestBox">
                <% if (currUser && listing.owner._id.equals(currUser._id) && listing.category === "Sell" && listing.AcceptStatus === 0) { %>
                    <!-- Display requests if the listing is for sale and has requests -->
                    <p class="requests">All Requests</p> 
                    <% listing.RequestedBy.forEach(request => { %>
                        <div class="requestItem"> 
                            <p class="email"><b>Email:</b><%= request.userId.email %><br> <b>Username:</b><%= request.userId.username %></p>
                            <!-- Form to accept request -->
                            <form action="/listings/<%= listing._id %>/<%= request.userId._id %>/accepted" method="POST">
                                <button style="height: 2rem; width: 6rem; padding: 0rem; margin-right: 0.5rem;" class="acceptButton btn btn-success">Accept</button>
                            </form>
                            <!-- Form to reject request -->
                            <form action="/listings/<%= listing._id %>/<%= request.userId._id %>/rejected" method="POST">
                                <button style="height: 2rem; width: 6rem; padding: 0rem;" class="rejectButton btn btn-danger">Reject</button>
                            </form>
                        </div>
                    <% }); %>
                    <% } %>
                    <% if (listing.category === 'Sell' && listing.AcceptStatus == 1) { %>
                      <!-- Display purchaser information -->
                      <p class="RequestedBy">Purchased By</p>
                          <div class="RequestedBy">
                              <p><b>Phone Number:</b> <%= listing.RequestedBy[0].phoneNumber %></p>
                              <p><b>Username:</b> <%= listing.RequestedBy[0].userId.username %></p>
                              <p><b>Email:</b> <%= listing.RequestedBy[0].userId.email %></p>
                              <!-- Add other purchase details as needed -->
                          </div>
                  <% } %>
                  
            </div>
            <div class="card-body">
              <p class="card-text">
                <ul>
                    <b>Owned By :</b> <i> <%= listing.owner.username %> </i><br>
                    <b>Contact:</b> <i> <%= listing.contact %> </i><br><br>
                    <% if( listing.category === "Rental" ) {%>
                      <b>Price:</b> &#x20B9; <%=listing.price.toLocaleString("en-IN")%>/month<br>
                       <%} else {%>
                         <b>Price:</b> &#x20B9; <%=listing.price.toLocaleString("en-IN")%><br>
                         <%}%>
                  <b>Description:</b>  <%=listing.description%><br>
                   <b>Location:</b> <%=listing.address%>/
                    <%=listing.location%><br> 

                </ul>
              </p>
            </div>
            </div>
            </div>
            
              <% if (currUser && !listing.owner._id.equals(currUser._id) && listing.category  === "Sell") { %>
                <form action="/listings/<%=listing._id%>/purchaseReq" method="POST">
                  <button style="margin-left: 20rem;" type="submit" class="btn btn-success">Purchase</button>
              </form>
            <% } %>
            <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
            <div class="btns" style="margin-left: 9rem;" >
              <a style="width: 4rem" class="btn btn-danger col-1 offset-3 add-btn"  href="/listings/<%=listing._id%>/edit">Edit</a>
                <form method="post"  action="/listings/<%=listing._id%>/delete?_method=DELETE">
                <button class="btn btn-dark offset-4">Delete</button>
                </form>
              </div>
              <% }%>
              <br>
           <%if(listing.reviews.length > 0){ %>

            <div class="row ">
              <h4>All Reviews</h4>
               <% for(review of listing.reviews) {%>
                 <div class="card col-8  ms-3 mb-3">
                   <div class="card-body" style="padding: 1rem;" >
                       <div class="rev" style="display: flex;">
                        <div class="card-title"> <b><%= review.author.username %></b></div>  <div style="margin-left: 20rem;" class="starability-result card-text" data-rating ="<%= review.rating %>">
                        </div><br> 
                       
                       </div>
                      <div class="imgReview">
                        <% for (let image of review.image) { %>
                          <img  style="height: 5rem; width: 5rem; border-radius: 0.3rem;" src="/uploads/<%= image %>" alt="review_image">
                        </div>
                      <% } %>
                      </div>
                      <p class="card-text"><%=review.comment%></p>
                       
                 </div>
                 <% if(currUser && review.author._id.equals(currUser._id)) { %>
                 <form class="mb-3" method="POST" action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE">
                   <button style="margin-left: 0.5rem;" class="btn btn-sm btn-dark">Delete</button>
                 </form>
                 <% }%>
                 </div><br>
              <% } %>
             </div>

            <%}%>
          </div>
        <!-- </div> -->
        <br>
            
            <div style="margin-left: 17rem;" class="col-8 offset-3 mb-3">
              <h3>Location Insight</h3>
              <div id="map"></div>
            </div>
          </div>
          <script src="/js/map.js" ></script>
              
    